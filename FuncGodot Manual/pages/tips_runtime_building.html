<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>FuncGodot Manual</title>
    <link rel="icon" type="image/x-icon" href="../images/godot_ranger.svg">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="main">
        <h1>Runtime Map Building</h1>
        <p>There are times where you may want to build maps while in the middle of running your game, whether it's for loading levels from map files instead of scenes, procedural generation, or as a way to support user-made maps. Runtime map building can also be combined with map editor launch configurations to provide a largely seamless experience between making a map and seeing it in-game.</p>
        <h2>Setting up Runtime Map Building</h2>
        <p>To build a map at Runtime, start by either using a templated scene with an empty <i>FuncGodotMap</i> or instantiating one. Next you'll need to make sure to set either the <code>local_map_file</code> or <code>global_map_file</code> to your map's file path. Don't use <code>load()</code> here! That will be taken care of in the next step.</p>
        <p>Once your map file path has been set, you can run the <code>verify_and_build()</code> method from the <a href="ref_func_godot_map.html" target="main">FuncGodotMap</a> node. When this is done, your map will be built just as it would have been by pressing the <i>Build</i> button in the Editor, along with all of the entity callbacks. Be aware that the <code>Engine.is_editor_hint()</code> conditional will return as false, in case you use it to control properties handling through the FuncGodot entity callbacks.</p>
        <p>When the map builds, it will emit the signals <code>build_complete</code> or <code>build_failed</code>. You can use these signals to handle errors gracefully and to run any post-build code you need to run.</p>
        <p>If using <a href="https://docs.godotengine.org/en/4.2/tutorials/3d/global_illumination/using_lightmap_gi.html" target="_blank">LightmapGI</a> for your global illumination solution, you can use the <i>FuncGodotMap</i> node's <code>unwrap_uv2()</code> method after receiving the <code>build_complete</code> signal. Once unwrapping has finished, the <i>FuncGodotMap</i> node will emit <code>unwrap_uv2_complete</code>.</p>
        <blockquote><i>NOTE: Godot 4.2 does not currently support runtime lightmap baking or UV2 unwrapping in exported builds. For now, consider using a different lighting solution for runtime building.<br></i></blockquote>
        An example of runtime map building is as follows:</p>
        <pre><code>extends Node

@onready var func_godot_map := $FuncGodotMap as FuncGodotMap

# We can connect the various build signals of the FuncGodotMap 
# in order to add more functionality after building.
func _ready():
    func_godot_map.connect("build_complete", _build_complete)
    func_godot_map.connect("build_failed", _build_failed)
    func_godot_map.connect("unwrap_uv2_complete", _unwrap_uv2_complete)
    func_godot_map.local_map_file = "res://maps/runtime_building.map"
    func_godot_map.verify_and_build()

# We need to wait for the build to finish before unwrapping mesh UV2s for lightmap baking.
# Currently lightmap baking cannot be performed at runtime, so it's not terribly useful yet.
# Consider creating a procedural Voxel GI solid class entity that can be baked at runtime instead.
func _build_complete() -> void:
    print("Success! Unwrapping UV2...")
    func_godot_map.unwrap_uv2()

func _build_failed() -> void:
    printerr("Failed to build the map file! :(")

func _unwrap_uv2_complete() -> void:
    print("UV2 unwrapping completed!")</code></pre>
    <p>An example of this can be found in <a href="https://github.com/func-godot/func_godot_runtime_building" target="_blank">func_godot_runtime_building repository</a>.</p>

    <h1>Building from Map Editors</h1>
    <p>
        Much like idTech engine games, it's possible to build and launch directly into a map from some map editors.
        This can be quite a helpful tool for testing rapid iterations.
    </p>

    <h2>Godot Project Setup Example</h2>
    <p>To build and launch our maps from the editor, you'll need to employ the <a href="https://docs.godotengine.org/en/stable/classes/class_os.html#class-os-method-get-cmdline-user-args" target="_blank">OS class' ability to retrieve command line arguments</a>. A basic example might look something like this:</p>

    <code><pre># This script should be autoloaded to handle command line arguments
# Additionally, requires a valid reference to a FuncGodot map

var func_godot_map: FuncGodotMap

var map_override: String
var cmd_line_args := OS.get_cmdline_user_args()

# Loop over all command line arguments, split on a delimiter for each command, and use this for the file path
for cmd_line_arg in cmd_line_args:
    if cmd_line_arg.contains("run_map::"):
        var arg_and_value := cmd_line_arg.split("::")
        # This should split into an array of size 2, containing the parameter name and its corresponding value
        if arg_and_value.size() != 2:
            return

        map_override = arg_and_value[1]

        func_godot_map.local_map_file = map_override
        func_godot_map.verify_and_build()</code></pre>
    <blockquote><i>NOTE: You can extend this to have more commands like God mode or Debug mode as your game needs, and use them when launching in editor.<br></i></blockquote>
    <h2>Setting Up Your Editor</h2>
    <p>In every map editor you'll need to specify both an <b>executable</b> and <b>parameters</b> in your launch or build options. The executable can be either the <b>exported binary of your game</b> or the <b>Godot Editor binary</b> if launching from a Godot project. To run from your game from the Godot project, be sure to use the <code>--path</code> parameter, as defined in <a href="https://docs.godotengine.org/en/stable/tutorials/editor/command_line_tutorial.html" target="_blank"><b>Godot's Command Line Interface options</b></a>.</p>
    <h3>TrenchBroom</h3>
    <p><a href="https://trenchbroom.github.io/manual/latest/#launching_game_engines"><b>The TrenchBroom Reference Manual</b></a> covers launch option configurations quite thoroughly. If you chose to use the Godot Editor for your launch executable, make sure to start your parameters with the <code>--path</code> command. You'll then add the <code>--run_map::</code> build command we defined earlier, using the built-in TrenchBroom variable <code>${MAP_BASE_NAME}</code> to get the name of the currently opened map file.</a>.</p>
    <p>An example of set of parameters to launch from the Godot Editor will look something like this: <code>--path "C:\GAME DEV\FuncGodot\test_project" -- run_map::${MAP_BASE_NAME}.map</code></p>
    <p>
        To run your map from TrenchBroom, navigate to <code>Run > Launch Engine</code>.
        Go to <code>Configure engines...</code>, add a game engine profile, and provide a name and path to the executable for this. For this example, we use the path to the Godot editor executable.
        Once you're happy with your engine configuration, click close. You will now see this as an option you can select. Select it.
        <p align="center"><img src="../images/tips_editorbuild_trenchbroom1.png"><br></p>
        <p>Now when you press Launch your game should launch using the parameters you defined!</p>
    </p>

    <h3>NetRadiant Custom</h3>

    <p>NetRadiant Custom utilizes a <code>default_build_menu.xml</code> file defined in your game's gamepack folder for its build processes. This file is automatically generated by NetRadiant Custom after setting up your gamepack configuration with the map editor, though it needs some additional setup in order to work with Runtime building.</p>
    <p>
        First, in Radiant, navigate to <code>Build > Customize...</code>.

        Here, we can see some build variables available:
        <p align="center"><img src="../images/tips_editorbuild_radiant1.png"><br></p>

        To create an entry, open up your build profile <code>&lt;path_to_radiant>\gamepacks\&lt;gamepack name>.game\default_build_menu.xml</code>.

        You can issue a command to execute depending on the currently running platform like so:

        <code><pre>&lt;?xml version="1.0"?>
&lt;project version="2.0">
    &lt;var name="game">"[EnginePath]example_project.[ExecutableType]"&lt;/var>
    &lt;build name="Run and build map in exported project">
        &lt;command>[game] -- run_map::"[MapFile]"&lt;/command>
    &lt;/build>
&lt;/project></code></pre>

        Restart NetRadiant, and you should see a new option in the build menu. Selecting your new option will run the command you defined above!
    </p>
</div>
<br><br><br>
</body>
</html>